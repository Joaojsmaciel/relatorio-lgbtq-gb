# Script para baixar dados adicionais do projeto
# Bases: homicídios Brasil, grupo LGBTQI+, local e raça/cor

# instalar os pacotes 
library(basedosdados)
library(tidyverse)
library(bigrquery)

# etapa 1: autenticar com sua conta Google
#isso abrirá uma janela no navegador para login
bq_auth()

# etapa 2:definir o ID do projeto da cobrança
basedosdados::set_billing_id("inspired-bus-461420-t4")

# ===== QUERY 1: Homicídios no Brasil =====
query_brasil <- "
SELECT
    dados.homicidios as homicidios,
    dados.ano as ano
FROM `basedosdados.br_ggb_relatorio_lgbtqi.brasil` AS dados
"

df_brasil <- basedosdados::read_sql(query_brasil,
                                   billing_project_id = basedosdados::get_billing_id())

write_csv(df_brasil, "data/homicidios_brasil.csv")

# ===== QUERY 2: Homicídios por grupo LGBTQI+ =====
query_grupo <- "
SELECT
    dados.grupo as grupo,
    dados.prop_homicidios_total as prop_homicidios_total,
    dados.ano as ano,
    dados.homicidios as homicidios
FROM `basedosdados.br_ggb_relatorio_lgbtqi.grupo_lgbtqia` AS dados
"

df_grupo <- basedosdados::read_sql(query_grupo,
                                  billing_project_id = basedosdados::get_billing_id())

write_csv(df_grupo, "data/homicidios_grupo.csv")

# ===== QUERY 3: Homicídios por local =====
query_local <- "
SELECT
    dados.homicidios as homicidios,
    dados.ano as ano,
    dados.local as local,
    dados.prop_homicidios_total as prop_homicidios_total
FROM `basedosdados.br_ggb_relatorio_lgbtqi.local` AS dados
"

df_local <- basedosdados::read_sql(query_local,
                                  billing_project_id = basedosdados::get_billing_id())

write_csv(df_local, "data/homicidios_local.csv")

# ===== QUERY 4: Homicídios por raça/cor =====
query_raca <- "
SELECT
    dados.ano as ano,
    dados.prop_homicidios_total as prop_homicidios_total,
    dados.homicidios as homicidios,
    dados.raca_cor as raca_cor
FROM `basedosdados.br_ggb_relatorio_lgbtqi.raca_cor` AS dados
"

df_raca <- basedosdados::read_sql(query_raca,
                                 billing_project_id = basedosdados::get_billing_id())

write_csv(df_raca, "data/homicidios_raca.csv")

# Resumo dos dados baixados
cat("=== RESUMO DOS DADOS BAIXADOS ===\n")
cat("Homicídios Brasil:", nrow(df_brasil), "registros\n")
cat("Homicídios por grupo:", nrow(df_grupo), "registros\n")
cat("Homicídios por local:", nrow(df_local), "registros\n")
cat("Homicídios por raça/cor:", nrow(df_raca), "registros\n") 